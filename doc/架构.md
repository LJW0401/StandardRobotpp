# 架构
## 总体介绍
### 机器人参数
机器人的主要选项在 [robot_typedef](../application/robot_typedef.h) 中定义。

在[robot_param](../application/robot_param.h)中导入个性化定义的每个机器人具体的物理参数，包括但不限于控制中要用到的物理参数、PID参数等等。

通过这种做法达到机器人代码通用化的目的，只需替换不同机器人的 `robot_param.h` 文件即可实现不同车型的适配。

### 模块控制
不同的模块由其对应的控制任务进行控制，如底盘为chassis_task，云台为gimbal_task，射击为shoot_task ... 

每个控制任务都可以分成以下几个步骤：
1. **初始化 (Initxxx)**：在进入任务循环前先行对该任务所需要的各种参数进行初始化。
2. **获取反馈 (xxxObserver)**：获取各种传感器的反馈数据，以便接下来进行控制处理。
3. **异常处理 (HandleException)**：在任务循环中遇到异常情况时如果有处理方法则进行异常处理（通常为电机失能等等），若无法处理且会造成危险的话则尝试进行报警。
4. **模式设置 (SetxxxMode)** ：设置对应模块的模式，在不同模式下模块会有不同的动作。
5. **更新目标 (xxxReference)**：更新各个目标值，作为控制的目标结果。
6. **计算控制量 (xxxConsole)**：计算出各个执行机构的控制量使得模块效果达到目标。
7. **发送控制量 (SendxxxCmd)**：将控制量发送给执行机构来执行。

整体的一个任务处理顺序如下：
```C
InitChassis();
while (1) {
    ChassisObserver();
    HandleException();
    SetChassisMode();
    ChassisReference();
    ChassisConsole();
    SendChassisCmd();
    vTaskDelay(CHASSIS_CONTROL_TIME_MS);
    }
```

### 示例
如果要将代码用于平衡步兵机器人
1. 我需要在 [robot_param_balanced_infantry.h](../application/robot_param_balanced_infantry.h) 文件中定义实现控制所需要的各种物理量。
2. 我需要在 [robot_param.h](../application/robot_param.h) 中导入 `robot_param_balanced_infantry.h` 的机器人参数。如下2行：
    ```C
    ...code...

    //导入具体的机器人参数配置文件
    #include "robot_param_balanced_infantry.h"

    ...code...

    ```

### 参数配件文件框架
```C

/**
  * @file       robot_param_xxx.h
  * @brief      这里是xxx机器人参数配置文件，包括物理参数、PID参数等
  */

#ifndef INCLUDED_ROBOT_PARAM_H
#define INCLUDED_ROBOT_PARAM_H
#include "robot_typedef.h"

#define CHASSIS_TYPE ...    // 选择底盘类型
#define GIMBAL_TYPE ...     // 选择云台类型
#define SHOOT_TYPE ...      // 选择发射机构类型
#define CONTROL_TYPE ...    // 选择控制类型

typedef enum {
...
} MotorId_e;

/*-------------------- Chassis --------------------*/
//physical parameters ---------------------
//upper_limit parameters ---------------------
//lower_limit parameters ---------------------
//PID parameters ---------------------
...
/*-------------------- Gimbal --------------------*/
//physical parameters ---------------------
//PID parameters ---------------------
...
/*-------------------- Shoot --------------------*/
//physical parameters ---------------------
//PID parameters ---------------------
...

#endif /* INCLUDED_ROBOT_PARAM_H */
```